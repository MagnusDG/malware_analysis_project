# Parameters
$sampleFolder = "C:\Users\flare\Desktop\wc"
$logFile = "C:\Users\flare\Desktop\log.txt"
$excelFile = "C:\Users\flare\Desktop\analysis_results.xlsx"
$yaraRulesFile = "C:\Users\flare\Desktop\rule.yar"

# Check if sample folder exists
if (-Not (Test-Path $sampleFolder)) {
    Write-Error "Sample folder does not exist: $sampleFolder"
    exit
}

# Create log file directory if it doesn't exist
$logFileDir = Split-Path $logFile
if (-Not (Test-Path $logFileDir)) {
    New-Item -Path $logFileDir -ItemType Directory
}

# Initialize result array
$results = @()

# Function to log the analysis time
function Log-AnalysisTime {
    param (
        [string]$sample,
        [datetime]$startTime,
        [datetime]$endTime,
        [string]$result
    )
    $analysisTime = $endTime - $startTime
    $resultEntry = [PSCustomObject]@{
        Sample       = $sample
        StartTime    = $startTime
        EndTime      = $endTime
        AnalysisTime = $analysisTime.TotalSeconds
        Result       = $result
    }
    $results += $resultEntry

    # Log to text file
    Add-Content -Path $logFile -Value "$($sample),$($startTime),$($endTime),$($analysisTime.TotalSeconds),$($result)"
}

# Iterate over each sample and analyze
Get-ChildItem -Path $sampleFolder -Recurse -Filter *.exe | ForEach-Object {
    $sample = $_.FullName
    $startTime = Get-Date

    # Call the YARA analysis tool
    $result = & "yara64.exe" -r $yaraRulesFile $sample

    $endTime = Get-Date
    Log-AnalysisTime -sample $sample -startTime $startTime -endTime $endTime -result $result
}

# Export results to Excel
$results | Export-Excel -Path $excelFile -AutoSize -WorksheetName "AnalysisResults"

Write-Output "Analysis completed and results exported to $excelFile"
