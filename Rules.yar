/*
   WannaCry Ransomware Detection Rule Set
   Author: Florian Roth
   Date: 2017-05-12
   Reference: https://goo.gl/HG2j5T
*/

rule wannacry_mix{
meta:
    description = "WannaCry Ransomware Detection Rule Set"
    author = "Florian Roth"
    date = "2017-05-12"
    reference = "https://goo.gl/HG2j5T"
    hash1 = "ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa"
    hash2 = "9fe91d542952e145f2244572f314632d93eb1e8657621087b2ca7f7df2b0cb05"
    hash3 = "51432d3196d9b78bdc9867a77d601caffd4adaa66dcac944a5ba0b3112bbea3b"
    hash4 = "f01b7f52e3cb64f01ddc248eb6ae871775ef7cb4297eba5d230d0345af9a5077"
    hash5 = "4a25d98c121bb3bd5b54e0b6a5348f7b09966bffeec30776e5a731813f05d49e"
    hash6 = "9c7c7149387a1c79679a87dd1ba755bc"
    hash7 = "ac21c8ad899727137c4b94458d7aa8d8"
    id = "2e46b4db-8c94-53ed-ae27-31dd37b04940"
    id = "d28d3d76-9c24-5476-9a0c-936c17477d6a"
    id = "a8f13bd2-984d-5c8c-ac53-7d442e222850"
    id = "0929f0de-28ac-5534-a6fd-7b131abda011"
    id = "65ce8faf-0981-5382-bc15-f094ccaa9f54"
    id = "e9dd9750-2366-503a-a879-972dbead6bf3"
    weight = 100

/* Strings and Conditions */
strings:
    $common_strings = {
        "icacls . /grant Everyone:F /T /C /Q",
        /* Add other common strings used in different rules */
    }

    /* Strings from rule 'wannacry_1' */
    $wannacry_1_strings = {
        "Ooops, your files have been encrypted!" wide ascii nocase,
        "Wanna Decryptor" wide ascii nocase,
        ".wcry" wide ascii nocase,
        "WANNACRY" wide ascii nocase,
        "WANACRY!" wide ascii nocase,
        /* Add more strings if needed */
    }

    /* Strings from rule 'wannacry_2' */
    $wannacry_2_strings = {
        "msg/m_bulgarian.wnry",
        "msg/m_chinese (simplified).wnry",
        /* Add more strings if needed */
    }

    /* Other strings from different rules */
    $other_strings = {
        ".TargetPath = \"C:\\@\" ascii",
        ".CreateShortcut(\"C:\\@\" ascii",
        /* Add more strings if needed */
    }

/* Conditions */
condition:
    uint16(0) == 0x5a4d and
    (
        /* Rule 'WannaCry_Ransomware' conditions */
        (filesize < 10000KB and (1 of ($common_strings) and 1 of ($other_strings) or 3 of (uint8(0) @ $common_strings)))

        or

        /* Rule 'WannaCry_Ransomware_Gen' conditions */
        (filesize < 5000KB and all of them)

        or

        /* Rule 'WannCry_m_vbs' conditions */
        (filesize < 1KB and all of (uint8(0) @ $common_strings))

        or

        /* Rule 'WannCry_BAT' conditions */
        (filesize < 1KB and 1 of ($other_strings))

        or

        /* Rule 'WannaCry_RansomNote' conditions */
        (filesize < 2KB and all of them)

        or

        /* Rule 'APT_lazaruswannacry' conditions */
        (filesize < 15000000 and all of ($common_strings))

        or

        /* Rule 'wannacry_1' conditions */
        (any of ($wannacry_1_strings))

        or

        /* Rule 'wannacry_2' conditions */
        (any of ($wannacry_2_strings))
    )

/* Meta Information */
meta:
    description = "WannaCry Ransomware Detection Rule Set"
    author = "Florian Roth"
    date = "2017-05-12"
    reference = "https://goo.gl/HG2j5T"
Rule 'WannCry_BAT' conditions */
        (filesize < 1KB and 1 of ($s1_bat, $s2_bat, $s3_bat, $s4_bat)) or
        /* Rule 'WannaCry_RansomNote' conditions */
        (filesize < 2KB and all of ($s1_note, $s2_note)) or
        /* Rule 'APT_lazaruswannacry' conditions */
        (filesize < 15000000 and all of ($a1_lazarus, $a2_lazarus)) or
        /* Rule 'wannacry_1' conditions */
        (any of ($wannacry_1_strings)) or
        /* Rule 'wannacry_2' conditions */
        (any of ($s1_gen, $s2_gen, $s3_gen, $s4_gen, $s5_gen))
    )

/* Meta Information */


}
